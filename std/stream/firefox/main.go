package main

import (
	"encoding/json"
	"fmt"
	"os"
	"sort"

	"github.com/ddkwork/golibrary/std/stream/firefox/bookmark"

	"github.com/ddkwork/golibrary/std/mylog"
)

type (
	Interface interface {
		Decode(fileName string)
		Sort()
		Encode()
		AllUrl() map[string]Children
	}
	object struct {
		childrens []Children
		allUrl    map[string]Children
	}
)

func main() {
	b := New()
	b.Decode("ffbmparse/bookmarks.json")
	b.Sort()
	b.Encode()
	mylog.Success("all bookmark", len(b.AllUrl()))
}

func (o *object) AllUrl() map[string]Children { return o.allUrl }
func New() Interface {
	return &object{
		childrens: make([]Children, 0),
		allUrl:    make(map[string]Children, 0),
	}
}

func (o *object) Decode(fileName string) {
	fi := mylog.Check2(os.Open(fileName))
	bookmarks := &bookmark.Item{}
	dec := json.NewDecoder(fi)
	mylog.Check(dec.Decode(bookmarks))
	DecodeJson(bookmarks, "", o.allUrl)
	for _, children := range o.allUrl {
		o.childrens = append(o.childrens, children)
	}
}

func (o *object) Sort() {
	sort.Slice(o.childrens, func(i, j int) bool { return o.childrens[i].URI < o.childrens[j].URI })
}

func (o *object) Encode() {
	start := `
{
	"guid": "root________",
	"title": "",
	"index": 0,
	"dateAdded": 1657177590438000,
	"lastModified": 1657182699187000,
	"id": 1,
	"typeCode": 2,
	"type": "text/x-moz-place-container",
	"root": "placesRoot",
	"children": [{
		"guid": "menu________",
		"title": "menu",
		"index": 0,
		"dateAdded": 1657177590438000,
		"lastModified": 1657182217688000,
		"id": 2,
		"typeCode": 2,
		"type": "text/x-moz-place-container",
		"root": "bookmarksMenuFolder"
	}, {
		"guid": "toolbar_____",
		"title": "toolbar",
		"index": 1,
		"dateAdded": 1657177590438000,
		"lastModified": 1657182699187000,
		"id": 3,
		"typeCode": 2,
		"type": "text/x-moz-place-container",
		"root": "toolbarFolder",
		"children": 
`

	end := `
	}, {
		"guid": "unfiled_____",
		"title": "unfiled",
		"index": 3,
		"dateAdded": 1657177590438000,
		"lastModified": 1657177590729000,
		"id": 5,
		"typeCode": 2,
		"type": "text/x-moz-place-container",
		"root": "unfiledBookmarksFolder"
	}, {
		"guid": "mobile______",
		"title": "mobile",
		"index": 4,
		"dateAdded": 1657177590480000,
		"lastModified": 1657177590729000,
		"id": 6,
		"typeCode": 2,
		"type": "text/x-moz-place-container",
		"root": "mobileFolder"
	}]
}
`
	marshal := mylog.Check2(json.MarshalIndent(&o.childrens, "", " "))
	body := start + string(marshal) + end
	fmt.Println(body)
	f := mylog.Check2(os.Create("ffbmparse/bookmarks_new.json"))
	mylog.Check2(f.WriteString(body))
}

func DecodeJson(bm *bookmark.Item, prefix string, allUrl map[string]Children) {
	if bm.TypeCode == bookmark.TypeFolder && len(bm.Children) > 0 {
		fmt.Printf("%sFolder: %s\n", prefix, bm.Title)
		for i := range bm.Children {
			DecodeJson(bm.Children[i], prefix+"\t", allUrl)
		}
	} else if bm.TypeCode == bookmark.TypeBookmark {
		allUrl[bm.URI] = Children{
			GUID:         bm.GUID,
			Title:        bm.Title,
			Index:        bm.Index,
			DateAdded:    bm.DateAdded,
			LastModified: bm.LastModified,
			ID:           bm.ID,
			TypeCode:     bm.TypeCode,
			Type:         bm.Type,
			URI:          bm.URI,
		}
	}
}

type AutoGenerated struct {
	GUID         string     `json:"guid"`
	Title        string     `json:"title"`
	Index        int        `json:"index"`
	DateAdded    int64      `json:"dateAdded"`
	LastModified int64      `json:"lastModified"`
	ID           int        `json:"id"`
	TypeCode     int        `json:"typeCode"`
	Type         string     `json:"type"`
	Root         string     `json:"root"`
	Children     []Children `json:"children"`
}
type Children struct {
	GUID         string `json:"guid"`
	Title        string `json:"title"`
	Index        int    `json:"index"`
	DateAdded    int64  `json:"dateAdded"`
	LastModified int64  `json:"lastModified"`
	ID           int    `json:"id"`
	TypeCode     int    `json:"typeCode"`
	Type         string `json:"type"`
	URI          string `json:"uri"`
}
